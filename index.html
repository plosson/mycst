<!doctype html>

<html lang="en" xmlns:x-on="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>My CST</title>
    <meta name="description" content="My CST - Store your CST safely">
    <meta name="author" content="My CST">

    <meta property="og:title" content="My CST">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://mycst.link/">
    <meta property="og:description" content="My CST - Store your CST safely">
    <meta property="og:image" content="https://mycst.link/public/img/favicon-152x152.png">

    <!-- Twitter Card data -->
    <meta name="twitter:card" content="summary"/>
    <meta name="twitter:title" content="My CST"/>
    <meta name="twitter:description" content="My CST - Store your CST safely"/>
    <meta name="twitter:image" content="https://mycst.link/public/img/favicon-152x152.png"/>

    <meta name="application-name" content="My CST"/>
    <script src="/bundle.js?ts=7"></script>
    <%= require('html-loader!./pages/head.html').default %>
    <script type="text/javascript">
        var html5QrCode = null;

        function data() {
            return {
                "library": this.$persist([]),
                "pass": {
                    "dob": "1975-01-01",
                    "dob_str": "January 1st 1975",
                    "age": 45,
                    "nam": {
                        "fn": "Denver",
                        "gn": "John",
                        "fnt": "DENVER",
                        "gnt": "JOHN"
                    }
                },
                "logo": "",
                "page": location.hash,
                "changePage": function (page) {
                    this.page = page;
                    if (page === '' || page === '#') {

                        // check if scanner is started
                        const that = this;
                        if (html5QrCode == null) {
                            html5QrCode = dgc.scanQR("videoContainer", getAspectRatio(), decodedText => {
                                that.savePass(decodedText);
                            });
                        }
                    } else {
                        if (html5QrCode != null) {
                            html5QrCode.stop();
                            html5QrCode = null;
                        }
                    }

                    if (page === '#upload') {

                        const fileinput = document.getElementById('qr-input-file');
                        const that = this;
                        dgc.uploadQR("imageContainer", "qr-input-file", decodedText => {
                            that.savePass(decodedText);
                            document.getElementById("imageContainer").innerHTML = "";
                            fileinput.value = "";
                        });
                    }

                    if (page === '#library') {
                    }
                },
                "initPass": function (data, logoId) {
                    let result = dgc.decodeDGC(data);
                    this.pass = result.json;
                    const text = result.text;

                    document.getElementById("qrcode").innerHTML = "";
                    document.getElementById("qrcode-large").innerHTML = "";

                    bodymovin.destroy();
                    bodymovin.loadAnimation({
                        container: document.getElementById('bm'),
                        renderer: 'svg',
                        loop: true,
                        autoplay: true,
                        path: '/public/json/qr_code.json'
                    });

                    bodymovin.loadAnimation({
                        container: document.getElementById('bm-large'),
                        renderer: 'svg',
                        loop: true,
                        autoplay: true,
                        path: '/public/json/qr_code.json'
                    });

                    dgc.createQR(document.getElementById("qrcode"), {
                        text: text,
                        width: 200,
                        height: 200,
                        colorDark: "#000000",
                        colorLight: "#ffffff",
                    });

                    let largeOptions = {
                        text: text,
                        width: 300,
                        height: 300,
                        colorDark: "#000000",
                        colorLight: "#ffffff",
                    };

                    if (logoId && logoId.length > 0) {
                        largeOptions.logo = `/public/img/qr_logo_${logoId}.png`;
                        largeOptions.logoWidth = 80;
                        largeOptions.logoHeight = 80;
                        largeOptions.logoBackgroundTransparent = false;
                    }

                    dgc.createQR(document.getElementById("qrcode-large"), largeOptions);

                    var canvas = document.querySelector('#qrcode > canvas'),
                        ctx = canvas.getContext('2d');
                    fitToContainer(canvas);

                    var canvas = document.querySelector('#qrcode-large > canvas'),
                        ctx = canvas.getContext('2d');

                    fitToContainer(canvas);
                },
                "encode": function () {
                    window.location.href = getPassUrl(this.pass.text, this.logo);
                },
                "savePass": function (data) {
                    let p = JSON.parse(JSON.stringify(dgc.decodeDGC(data)));
                    p.logo = this.logo;
                    this.library.push(p);
                    this.showPass(data);
                },
                "showPass": function (data) {
                    console.log(data);
                    window.location.href = getPassUrl(data, this.logo);
                },
                "formatDate": function (date, format) {
                    return dgc.formatDate(date, format);
                },
                "init": function () {
                    const url = dgc.parseUrl(window.location.href);
                    if (url.query.logo) {
                        this.logo = url.query.logo;
                    }
                    if (url.query.p0) {
                        const merged = dgc.mergeQS(url.query, "p");
                        this.initPass(dgc.decode64(merged), url.query.logo);
                        if (this.page === '') {
                            this.changePage('#qr');
                        }
                    }
                    this.changePage(location.hash);
                },
            }
        }

        function getPassUrl(text, logo) {
            try {
                var url = "?" + dgc.splitQS(dgc.encode64(text), "p");
                if (logo && logo.length > 0) {
                    url = url + "&logo=" + logo;
                }
            } catch (e) {
                console.log(e);
            }
            return url + "#qr";
        }

        function fitToContainer(canvas) {
            canvas.style.width = '100%';
            canvas.style.height = '100%';
        }

        function getAspectRatio() {
            const realWidth = window.screen.width * window.devicePixelRatio;
            const realHeight = window.screen.height * window.devicePixelRatio;
            const aspectRatio = realHeight / realWidth;
            console.log(aspectRatio);
            return aspectRatio;
        }

    </script>
</head>

<body x-data="data" id="body" class="flex flex-col" @hashchange.window="changePage(location.hash)">
<%= require('html-loader!./pages/home.html').default %>
<%= require('html-loader!./pages/qr/view.html').default %>
<%= require('html-loader!./pages/qr/detail.html').default %>
<%= require('html-loader!./pages/qr/encode.html').default %>
<%= require('html-loader!./pages/library.html').default %>
<%= require('html-loader!./pages/upload.html').default %>
<%= require('html-loader!./pages/footer.html').default %>
</body>