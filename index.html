<!doctype html>

<html lang="en" xmlns:x-on="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>My CST</title>
    <meta name="description" content="My CST - Store your CST safely">
    <meta name="author" content="My CST">

    <meta property="og:title" content="My CST">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://my-cst.link/">
    <meta property="og:description" content="My CST - Store your CST safely">
    <meta property="og:image" content="https://my-cst.link/public/img/favicon-152x152.png">

    <!-- Twitter Card data -->
    <meta name="twitter:card" content="summary"/>
    <meta name="twitter:title" content="My CST"/>
    <meta name="twitter:description" content="My CST - Store your CST safely"/>
    <meta name="twitter:image:src" content="https://my-cst.link/public/img/favicon-152x152.png"/>

    <meta name="application-name" content="My CST"/>
    <script src="/bundle.js"></script>
    <%= require('html-loader!./head.html').default %>
    <script src="/public/js/html5-qrcode.min.js" type="text/javascript"></script>
    <script type="text/javascript">
        var html5QrCode = null;
        var cameraId = null;

        function data() {
            return {
                "pass": {
                    "dob": "1975-01-01",
                    "dob_str": "January 1st 1975",
                    "age": 45,
                    "nam": {
                        "fn": "Denver",
                        "gn": "John",
                        "fnt": "DENVER",
                        "gnt": "JOHN"
                    }
                },
                "page": location.hash,
                "changePage": function (page) {
                    if (location.hash !== page){
                        this.page = page;
                        location.hash = page;
                    }
                },
                "cameraId": "",
                "initPass": function (data) {
                    let result = dgc.decodeDGC(data);
                    this.pass = result.json;
                    const text = result.text;

                    document.getElementById("qrcode").innerHTML = "";
                    document.getElementById("qrcode-large").innerHTML = "";
                    const qr = new QRCode(document.getElementById("qrcode"), {
                        text: text,
                        width: 200,
                        height: 200,
                        colorDark: "#000000",
                        colorLight: "#ffffff",
                        correctLevel: QRCode.CorrectLevel.H
                    });
                    const qr_large = new QRCode(document.getElementById("qrcode-large"), {
                        text: text,
                        width: 300,
                        height: 300,
                        colorDark: "#000000",
                        colorLight: "#ffffff",
                        correctLevel: QRCode.CorrectLevel.H
                    });

                    bodymovin.destroy();
                    bodymovin.loadAnimation({
                        container: document.getElementById('bm'),
                        renderer: 'svg',
                        loop: true,
                        autoplay: true,
                        path: '/public/json/qr_code.json'
                    });

                    bodymovin.loadAnimation({
                        container: document.getElementById('bm-large'),
                        renderer: 'svg',
                        loop: true,
                        autoplay: true,
                        path: '/public/json/qr_code.json'
                    });
                },
                "showPass": function (data) {
                    window.location.href = "?" + dgc.splitQS(dgc.encode64(data),"p") + '#qr';
                },
                "formatDate": function (date, format) {
                    return dgc.formatDate(date, format);
                },
                "startScanning": function () {
                    html5QrCode = new Html5Qrcode("videoContainer", {formatsToSupport: [Html5QrcodeSupportedFormats.QR_CODE]});
                    html5QrCode.start(this.cameraId, {
                            fps: 10,
                            rememberLastUsedCamera: true,
                            aspectRatio: getAspectRatio()
                        },
                        decodedText => {
                            try {
                                this.showPass(decodedText, true);
                            } catch (e) {
                                console.log(e);
                            }
                        },
                        errorMessage => {
                        })
                        .catch(err => {
                        });

                    const fileinput = document.getElementById('qr-input-file');
                    const that = this;
                    fileinput.addEventListener('change', e => {
                        if (e.target.files.length == 0) {
                            return;
                        }
                        const imageFile = e.target.files[0];
                        // Scan QR Code
                        const that = this;
                        html5QrCode.stop();
                        html5QrCode.scanFile(imageFile, true)
                            .then(decodedText => {
                                that.showPass(decodedText);
                            })
                            .catch(err => {
                                // failure, handle it.
                                console.log(`Error scanning file. Reason: ${err}`)
                            });
                    });


                },
                "init": function () {
                    const url = dgc.parseUrl(window.location.href);
                    if (url.query.p0) {
                        const merged = dgc.mergeQS(url.query,"p");
                        this.initPass(dgc.decode64(merged));
                        if (this.page === ''){
                            this.changePage('#qr');
                        }
                    } else {
                        // This method will trigger user permissions
                        Html5Qrcode.getCameras().then(devices => {
                            //console.log(devices);
                            if (devices && devices.length) {
                                {
                                    this.cameraId = devices[devices.length - 1].id;
                                    this.startScanning();
                                }
                            }
                        }).catch(err => {
                            console.log(err);
                        });
                    }
                },
            }
        }

        function getAspectRatio() {
            const realWidth = window.screen.width * window.devicePixelRatio;
            const realHeight = window.screen.height * window.devicePixelRatio;
            const aspectRatio = realHeight / realWidth;
            return aspectRatio;
        }

    </script>
</head>

<body x-data="data" id="body" class="flex flex-col">
<div id="main" x-show="page===''" x-cloak>
    <main class="photo flex-1 overflow-y-auto bg-black" id="videoContainer"></main>
    <div class="w-full h-screen">
        <section id="bottom-navigation" class="block fixed inset-x-0 bottom-10 z-10 flex flex-row justify-center">
            <input type="file" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded"
                   id="qr-input-file" accept="image/*">
        </section>
    </div>
</div>
<div id="qr" x-show="page=='#qr'" class="p-4 flex flex-col items-center bg-green-50 h-screen" x-cloak>
    <div id="qr-content" class="w-7/12">
        <div id="bm"></div>
        <div id="qrcode" x-on:click="changePage('#details')"></div>
    </div>
    <div id="info">
        <p class="text-xs mt-2">Tap the QR-code to enlarge</p>
    </div>
    <div class="w-11/12 mt-5 p-3 bg-black text-gray-200 relative overflow-hidden rounded-xl flex flex-col"
         style="background-image: url('/public/img/eu_avatar_big_light_cropped.png'); background-repeat: no-repeat; background-position: right 0 top 0;">
        <div class="mb-2">
            <p class="text-xs">Last name</p>
            <p><span x-text="pass.nam.fn"></span></p>
        </div>
        <div class="mb-2">
            <p class="text-xs">Given name</p>
            <p><span x-text="pass.nam.gn"></span></p>
        </div>
        <div class="mb-2">
            <p class="text-xs">Date of birth</p>
            <p><span x-text="pass.dob"></span></p>
        </div>
    </div>
</div>
<div id="qr-detail" x-show="page=='#details'" class="p-4 flex flex-col h-screen items-center" x-cloak>
    <div id="qr-content-large" class="mt-20">
        <div id="bm-large"></div>
        <div id="qrcode-large" class="object-scale-down w-11/12"></div>
    </div>
    <div class="mt-5">
        <a href="#" x-on:click="changePage('#qr')" class="font-bold">Back to overview</a>
    </div>
</div>

</body>